<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rei da V√°rzea</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#FFD700"/>
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/images/icons/icon-192.png">

    <style>
        /* CSS Completo com as novas classes */
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');
        :root { --cor-amarelo: #FFD700; --cor-amarelo-hover: #E6C200; --cor-azul: #0057B7; --cor-fundo: #000000; --cor-fundo-container: #1A1A1A; --cor-texto: #FFFFFF; --cor-texto-secundario: #BDBDBD; --cor-input-fundo: #333333; --cor-input-borda: #444444; --cor-confirmado: #28a745; --cor-rejeitado: #dc3545; --cor-pendente: #ffc107;}
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Roboto', sans-serif; background-color: var(--cor-fundo); color: var(--cor-texto); display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
        .container { width: 100%; max-width: 450px; }
        .form-container { position: relative; background-color: var(--cor-fundo-container); padding: 30px 40px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        .logo-container { text-align: center; margin-bottom: 20px; }
        .logo-img { max-width: 250px; height: auto; }

        h2, .section-title { text-align: center; margin-bottom: 20px; font-weight: 400; color: var(--cor-texto-secundario); }
        .input-group { margin-bottom: 20px; }
        .input-group label { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-size: 0.9em; color: var(--cor-texto-secundario); }
        .input-group input, .input-group select, .input-group textarea { width: 100%; padding: 12px; background-color: var(--cor-input-fundo); border: 1px solid var(--cor-input-borda); border-radius: 6px; color: var(--cor-texto); font-size: 1em; }
        .btn { padding: 12px; border-radius: 6px; cursor: pointer; font-size: 1em; font-weight: 700; border: none; transition: all 0.2s ease-in-out; }
        .btn:disabled { background-color: #555 !important; color: #888 !important; cursor: not-allowed !important; }
        .btn-profile { flex-grow: 1; background-color: var(--cor-input-fundo); border: 1px solid var(--cor-input-borda); color: var(--cor-texto); }
        .btn-profile.selected { background-color: var(--cor-amarelo); border-color: var(--cor-amarelo); color: var(--cor-fundo); }
        .profile-selection { display: flex; gap: 15px; margin-bottom: 30px; }
        .btn-submit { width: 100%; padding: 15px; background-color: var(--cor-amarelo); color: var(--cor-fundo); font-size: 1.1em; }
        .btn-secondary { background-color:transparent; border: 1px solid var(--cor-azul); color: var(--cor-azul); width: 100%; margin-top: 10px;}
        
        .btn-install { width: 100%; margin-top: 10px; background-color: var(--cor-amarelo); color: var(--cor-fundo); }
        .btn-install:hover { background-color: var(--cor-amarelo-hover); }

        .login-link { text-align: center; margin-top: 20px; font-size: 0.9em; }
        a { color: var(--cor-azul); text-decoration: none; }
        .game-card { background-color: var(--cor-input-fundo); border-left: 5px solid var(--cor-amarelo); padding: 20px; border-radius: 6px; margin-bottom: 20px; }
        .game-card.confirmed { border-left-color: var(--cor-confirmado); }
        .game-card.rejected { border-left-color: var(--cor-rejeitado); }
        .confirmation-buttons { display: flex; gap: 10px; margin-top: 20px; }
        .btn-confirm { background-color: var(--cor-confirmado); color: white; flex-grow: 1; }
        .btn-reject { background-color: var(--cor-rejeitado); color: white; flex-grow: 1; }
        .dimmed { opacity: 0.4; }
        .attendance-list { margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--cor-input-borda); }
        .attendance-list h4 { color: var(--cor-amarelo); }
        .modal-overlay, .popup-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.85); display: flex; justify-content: center; align-items: center; z-index: 1000; padding: 20px; }
        .vote-card, .edit-modal-card, .confirm-modal-card, .help-modal-card { background-color: var(--cor-fundo-container); padding: 30px; border-radius: 12px; width: 100%; max-width: 500px; border-top: 5px solid var(--cor-amarelo); }
        .confirm-modal-card { border-top-color: var(--cor-rejeitado); }
        .help-modal-card { border-top-color: var(--cor-azul); }
        .help-modal-card ul { list-style-position: inside; padding-left: 10px; }
        .help-modal-card li { margin-bottom: 10px; }
        .player-vote-list { list-style: none; padding: 0; margin: 20px 0; max-height: 200px; overflow-y: auto; }
        .player-vote-list li button { width: 100%; text-align: left; margin-bottom: 10px; }
        .btn-skip-vote { background: none; border: none; color: var(--cor-texto-secundario); text-decoration: underline; width: 100%; margin-top: 15px; }
        
        .dashboard-notification-area { margin-bottom: 20px; }
        .dashboard-notification { position: relative; background: linear-gradient(45deg, var(--cor-azul), #003366); color: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; font-size: 0.9em; }
        .dashboard-notification.mvp { background: linear-gradient(45deg, var(--cor-amarelo), #ffec80); color: #333; }
        .dashboard-notification p { margin: 0 0 5px 0; font-weight: bold; }
        .dashboard-notification strong { font-weight: 700; }
        .notification-close-btn { position: absolute; top: 5px; right: 8px; background: none; border: none; color: inherit; font-size: 1.2em; cursor: pointer; opacity: 0.7; }
        .dashboard-notification .btn-notification-action { background-color: rgba(255,255,255,0.2); border: 1px solid white; color: white; padding: 8px 12px; border-radius: 5px; margin-top: 10px; font-size: 0.9em; }


        .goal-registration-item { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; }
        .goal-registration-item label { flex-grow: 1; }
        .goal-registration-item input { width: 80px; text-align: center; padding: 12px; background-color: #555; border: 1px solid #666; border-radius: 6px; color: var(--cor-texto); font-size: 1.1em;}
        .score-input-container { display: flex; justify-content: center; align-items: center; gap: 10px; margin: 20px 0; }
        .score-input-container input { width: 70px; text-align: center; font-size: 1.2em; }
        .winner-selection .input-group { margin-bottom: 10px; text-align: left; }
        .winner-selection .input-group label { display: flex; align-items: center; }
        .winner-selection .input-group input { width: auto; margin-right: 10px; }
        .player-list { list-style: none; padding: 0; max-height: 300px; overflow-y: auto; }
        .player-list-item { display: flex; justify-content: space-between; align-items: center; background-color: var(--cor-input-fundo); padding: 10px 15px; border-radius: 6px; margin-bottom: 10px; }
        .player-info span { display: block; }
        .player-info .position { font-size: 0.8em; color: var(--cor-amarelo); font-weight: bold; }
        
        .invite-box { background-color: var(--cor-input-fundo); border: 1px dashed var(--cor-input-borda); padding: 20px; text-align: center; border-radius: 6px; margin: 20px 0; display: flex; flex-direction: column; align-items: center; gap: 15px; }
        .invite-code { font-size: 1.5em; font-weight: 700; color: var(--cor-amarelo); letter-spacing: 2px; }
        
        .share-button { display: flex; align-items: center; gap: 8px; background-color: var(--cor-amarelo); color: var(--cor-fundo); padding: 10px 20px; border-radius: 20px; text-decoration: none; font-weight: bold; font-size: 0.9em; transition: background-color 0.2s; }
        .share-button:hover { background-color: var(--cor-amarelo-hover); }

        .dashboard-header { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        .team-logo { width: 50px; height: 50px; background-color: var(--cor-amarelo); color: var(--cor-fundo); display: flex; justify-content: center; align-items: center; border-radius: 8px; font-size: 1.8em; font-weight: 700; flex-shrink: 0; overflow: hidden; }
        .team-logo img { width: 100%; height: 100%; object-fit: cover; }
        .team-info { flex-grow: 1; }
        .team-name-container, .welcome-message { display: flex; align-items: center; gap: 8px; }
        .team-name { font-size: 1.5em; font-weight: 700; color: var(--cor-texto); }
        .welcome-message { font-size: 0.9em; color: var(--cor-texto-secundario); }
        .edit-icon { cursor: pointer; opacity: 0.6; transition: opacity 0.2s; color: var(--cor-texto-secundario); }
        .edit-icon:hover { opacity: 1; }
        .help-icon { cursor: pointer; color: var(--cor-azul); }
        .logout-icon { position: absolute; top: 15px; right: 15px; cursor: pointer; color: var(--cor-azul); }
        .logout-icon:hover { opacity: 0.8; }
        .remove-player-icon { cursor: pointer; color: var(--cor-rejeitado); }
        .remove-player-icon:hover { opacity: 0.7; }
        .btn-danger { background-color: var(--cor-rejeitado); color: white; }
        .terms-group { font-size: 0.8em; display: flex; align-items: center; gap: 10px; margin-top: 20px; }
        .terms-group input { width: auto; }

        .payment-details-box { background-color: var(--cor-input-fundo); border-radius: 8px; padding: 20px; margin: 20px 0; }
        .payment-details-box p { margin-bottom: 10px; }
        .payment-details-box strong { color: var(--cor-amarelo); }

        /* Estilos para o Interruptor de Pagamento */
        .toggle-switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--cor-rejeitado); transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--cor-confirmado); }
        input:checked + .slider:before { transform: translateX(26px); }
        .player-list-item.awaiting-approval { background-color: #494a21; }
        .payment-status-box { text-align: center; margin-bottom: 20px; padding: 10px; border-radius: 6px; font-weight: bold; }
        .status-paid { background-color: var(--cor-confirmado); color: white; }
        .status-pending { background-color: var(--cor-rejeitado); color: white; }
        .status-awaiting { background-color: var(--cor-pendente); color: black; }
        .notification-dot {
            height: 10px;
            width: 10px;
            background-color: var(--cor-pendente);
            border-radius: 50%;
            display: inline-block;
            margin-left: 8px;
            animation: pulse 1.5s infinite;
        }
        .awaiting-approval-details { font-size: 0.8em; color: var(--cor-texto-secundario); margin-top: 5px; }
        .awaiting-approval-details strong { color: var(--cor-pendente); }
        .alternative-payment-info { font-size: 0.85em; text-align: center; color: var(--cor-texto-secundario); margin-top: 20px; line-height: 1.5; }

        @keyframes pulse {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(255, 193, 7, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 193, 7, 0); }
        }
    </style>
</head>
<body>
    <main class="container" id="main-container">
        <!-- O conte√∫do da aplica√ß√£o ser√° renderizado aqui pelo JavaScript -->
        <div class="form-container" style="text-align: center;">
            <div class="logo-container"><img src="https://i.imgur.com/VQjRRHl.png" alt="Logo Rei da V√°rzea" class="logo-img"></div>
            <p>Carregando...</p>
        </div>
    </main>

    <script type="module">
        // =================================================================================
        //  1. INICIALIZA√á√ÉO E CONFIGURA√á√ÉO DO FIREBASE
        // =================================================================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, GoogleAuthProvider, signInWithPopup, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, collection, query, where, onSnapshot, serverTimestamp, writeBatch, getDocs, deleteDoc, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        const firebaseConfig = {
            // SUAS CREDENCIAIS DO FIREBASE AQUI
            apiKey: "AIzaSyDybx8XH8UeZvQQvQhnse9wcZLATft5tiA",
            authDomain: "rei-da-varzea.firebaseapp.com",
            projectId: "rei-da-varzea",
            storageBucket: "rei-da-varzea.appspot.com",
            messagingSenderId: "486496822825",
            appId: "1:486496822825:web:dcccd95a708220c0b6de38",
            measurementId: "G-ZKS7EBLTHL"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // =================================================================================
        //  2. ESTADO GLOBAL E VARI√ÅVEIS PRINCIPAIS
        // =================================================================================
        const AppState = {
            currentUser: null,
            userData: null,
            team: null,
            players: [],
            games: [],
            confirmations: {},
            votes: {},
            goals: {},
            payments: {},
            unsubscribe: () => {},
            selectedProfile: null,
            deferredPrompt: null,
        };

        // =================================================================================
        //  M√ìDULO DE AUTENTICA√á√ÉO E USU√ÅRIO (Auth)
        // =================================================================================
        const Auth = {
            handleLogin: async (e) => { e.preventDefault(); try { await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value); } catch (error) { alert('Utilizador ou senha inv√°lidos!'); } },
            handleLogout: async () => { await signOut(auth); },
            handleCadastroSubmit: async (e) => {
                e.preventDefault();
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                const confirmPassword = document.getElementById('confirm-password').value;
                const name = document.getElementById('nome').value;
                const terms = document.getElementById('terms-agree').checked;

                if (!name || !email || !password || !AppState.selectedProfile) return alert("Preencha todos os campos e selecione um perfil.");
                if (password !== confirmPassword) return alert("Erro: As senhas n√£o conferem!");
                if (!terms) return alert("Voc√™ precisa aceitar os Termos de Uso e Pol√≠tica de Privacidade para criar uma conta.");

                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    await setDoc(doc(db, "users", userCredential.user.uid), { name, nickname: document.getElementById('apelido').value, email, profile: AppState.selectedProfile, position: AppState.selectedProfile === 'jogador' ? document.getElementById('posicao').value : null, teamId: null, createdAt: serverTimestamp() });
                } catch (error) {
                    alert("Erro ao criar conta: " + error.message);
                }
            },
            handleForgotPassword: async (e) => { e.preventDefault(); const email = document.getElementById('email-reset').value; if (!email) { return alert("Por favor, digite seu e-mail."); } try { await sendPasswordResetEmail(auth, email); alert("Se houver uma conta com este e-mail, um link para redefini√ß√£o de senha foi enviado. Verifique sua caixa de entrada e spam!"); UI.render(UI.screenLogin); } catch (error) { console.error("Erro ao enviar e-mail de recupera√ß√£o:", error); alert("Ocorreu um erro. Verifique o e-mail digitado e tente novamente."); } },
            handleGoogleSignIn: async () => { const provider = new GoogleAuthProvider(); try { const result = await signInWithPopup(auth, provider); const user = result.user; const userDocRef = doc(db, "users", user.uid); const docSnap = await getDoc(userDocRef); if (!docSnap.exists()) { await setDoc(userDocRef, { name: user.displayName, email: user.email, profile: null, teamId: null, createdAt: serverTimestamp() }); } } catch (error) { console.error("Erro no login com Google: ", error); alert("N√£o foi poss√≠vel fazer login com o Google. Tente novamente."); } },
            handleProfileSelection: async (e) => { e.preventDefault(); if (!AppState.selectedProfile) return alert("Por favor, selecione um perfil."); const dataToUpdate = { profile: AppState.selectedProfile, position: AppState.selectedProfile === 'jogador' ? document.getElementById('posicao').value : null, }; try { await updateDoc(doc(db, "users", AppState.currentUser.uid), dataToUpdate); } catch(error) { console.error("Erro ao salvar perfil: ", error); alert("Ocorreu um erro ao salvar seu perfil."); } },
            handleUpdateUser: async (e) => { e.preventDefault(); const newName = document.getElementById('edit-nome').value; const newNickname = document.getElementById('edit-apelido').value; if (!newName) return alert('O nome n√£o pode ficar em branco.'); try { await updateDoc(doc(db, "users", AppState.currentUser.uid), { name: newName, nickname: newNickname }); alert('Perfil atualizado com sucesso!'); if (AppState.userData.profile === 'dono') UI.render(UI.screenDonoDashboard); else UI.render(UI.screenJogadorDashboard); } catch (error) { console.error("Erro ao atualizar perfil:", error); alert('N√£o foi poss√≠vel atualizar o perfil.'); } },
        };

        // =================================================================================
        //  M√ìDULO DE TIME (Team) - ATUALIZADO
        // =================================================================================
        const Team = {
            handleDonoSubmit: async (e) => { 
                e.preventDefault(); 
                const teamName = document.getElementById('nome-time').value; 
                if (!teamName) return alert('Digite o nome do time.'); 
                const teamCode = `${teamName.substring(0, 4).toUpperCase()}${Math.floor(1000 + Math.random() * 9000)}`; 
                const newTeamData = { name: teamName, ownerId: AppState.currentUser.uid, code: teamCode, createdAt: serverTimestamp(), subscription: { level: 'free', status: 'active' } };
                const newTeamRef = await addDoc(collection(db, "teams"), newTeamData); 
                await updateDoc(doc(db, "users", AppState.currentUser.uid), { teamId: newTeamRef.id }); 
            },
            handleJogadorSubmit: async (e) => { 
                e.preventDefault(); 
                const code = document.getElementById('codigo-time').value.toUpperCase(); 
                const q = query(collection(db, "teams"), where("code", "==", code)); 
                const querySnapshot = await getDocs(q); 
                if (!querySnapshot.empty) { 
                    // NOVO: Adiciona status de aprova√ß√£o pendente
                    await updateDoc(doc(db, "users", AppState.currentUser.uid), { 
                        teamId: querySnapshot.docs[0].id,
                        approved: false 
                    }); 
                } else { 
                    alert("C√≥digo de convite inv√°lido!"); 
                } 
            },
            handleApprovePlayer: async (playerId) => {
                try {
                    await updateDoc(doc(db, "users", playerId), { approved: true });
                } catch (error) {
                    console.error("Erro ao aprovar jogador:", error);
                    alert("N√£o foi poss√≠vel aprovar o jogador.");
                }
            },
            handleUpdateTeam: async (e) => {
                e.preventDefault();
                const newTeamName = document.getElementById('edit-team-name').value;
                const newLogoUrl = document.getElementById('edit-team-logo').value;
                if (!newTeamName) return alert('O nome do time n√£o pode ficar em branco.');
                try {
                    await updateDoc(doc(db, "teams", AppState.team.id), { name: newTeamName, logoUrl: newLogoUrl });
                    alert('Time atualizado com sucesso!');
                    UI.render(UI.screenDonoDashboard);
                } catch (error) { console.error("Erro ao atualizar time:", error); alert('N√£o foi poss√≠vel atualizar o time.'); }
            },
            handleLeaveTeam: () => { UI.render(UI.screenConfirmAction, { title: 'Sair do Time', message: 'Voc√™ tem certeza que deseja sair do time? Esta a√ß√£o n√£o pode ser desfeita.', confirmAction: 'confirm-leave-team' }); },
            confirmLeaveTeam: async () => { try { if (typeof AppState.unsubscribe === 'function') { AppState.unsubscribe(); AppState.unsubscribe = () => {}; } await updateDoc(doc(db, "users", AppState.currentUser.uid), { teamId: null }); } catch (error) { console.error("Erro ao sair do time:", error); alert("N√£o foi poss√≠vel sair do time. Tente novamente."); } },
            handleRemovePlayer: (playerId, playerName) => { UI.render(UI.screenConfirmAction, { title: 'Remover Jogador', message: `Voc√™ tem certeza que deseja remover ${playerName} do time?`, confirmAction: 'confirm-remove-player', targetId: playerId }); },
            confirmRemovePlayer: async (playerId) => { try { await updateDoc(doc(db, "users", playerId), { teamId: null }); alert("Jogador removido com sucesso!"); UI.render(UI.screenElenco); } catch (error) { console.error("Erro ao remover jogador:", error); alert("N√£o foi poss√≠vel remover o jogador. Tente novamente."); } },
            handleDevUpgrade: async () => {
                if (!AppState.team) return;
                try {
                    await updateDoc(doc(db, "teams", AppState.team.id), { subscription: { level: "varzea", status: "active" } });
                } catch (error) { console.error("Erro ao atualizar para plano V√°rzea:", error); alert("N√£o foi poss√≠vel fazer o upgrade de teste."); }
            }
        };

        // =================================================================================
        //  M√ìDULO DE JOGO (Game)
        // =================================================================================
        const Game = {
            handleAgendarJogo: async (e) => { 
                e.preventDefault(); 
                const duration = document.getElementById('game-duration').value;
                const gamesCollectionRef = collection(db, "teams", AppState.userData.teamId, "games");
                await addDoc(gamesCollectionRef, { 
                    teamId: AppState.userData.teamId, 
                    opponent: document.getElementById('opponent').value, 
                    location: document.getElementById('location').value, 
                    dateTime: new Date(`${document.getElementById('game-date').value}T${document.getElementById('game-time').value}`).toISOString(),
                    duration: parseInt(duration) || 90,
                    votingOpen: false, 
                    resultsEntered: false, 
                    createdAt: serverTimestamp() 
                }); 
            },
            handleReagendarJogo: (gameData) => {
                UI.render(UI.screenAgendarJogo, { oldGame: gameData });
            },
            handleConfirmation: async (gameId, status) => { 
                const confirmationRef = doc(db, `teams/${AppState.userData.teamId}/games/${gameId}/confirmations`, AppState.currentUser.uid);
                const docSnap = await getDoc(confirmationRef); 
                if (docSnap.exists() && docSnap.data().status === status) { 
                    await deleteDoc(confirmationRef); 
                } else { 
                    await setDoc(confirmationRef, { userId: AppState.currentUser.uid, status }); 
                } 
            },
            handleRegisterResults: (gameId) => { const game = AppState.games.find(g => g.id === gameId); UI.render(UI.screenRegisterResult, { game }); },
            handleGameResultSubmit: async (e, game) => { 
                e.preventDefault(); 
                const winnerRadio = document.querySelector('input[name="winner"]:checked'); 
                if (!winnerRadio) return alert("Por favor, selecione o resultado da partida."); 
                const winner = winnerRadio.value; 
                const scoreHome = parseInt(document.getElementById('score-home').value) || 0; 
                const scoreAway = parseInt(document.getElementById('score-away').value) || 0; 
                if ((winner === 'home' && scoreHome <= scoreAway) || (winner === 'away' && scoreHome >= scoreAway) || (winner === 'draw' && scoreHome !== scoreAway)) return alert('Resultado inconsistente com o placar!'); 
                await updateDoc(doc(db, "teams", AppState.userData.teamId, "games", game.id), { result: { winner, score: { home: scoreHome, away: scoreAway } } });
                UI.render(UI.screenRegistrarGols, { game }); 
            },
            handleGoalSubmit: async (e, game) => { 
                e.preventDefault(); 
                const inputs = e.target.querySelectorAll('input[type="number"]'); 
                let totalGoals = 0; 
                const batch = writeBatch(db); 
                inputs.forEach(input => { 
                    const quantity = parseInt(input.value) || 0; 
                    if (quantity > 0) { 
                        totalGoals += quantity; 
                        const goalRef = doc(db, `teams/${AppState.userData.teamId}/games/${game.id}/goals`, input.dataset.playerId);
                        batch.set(goalRef, { playerId: input.dataset.playerId, quantity }); 
                    } 
                }); 
                if (game.result.score.home !== totalGoals) return alert(`O n√∫mero de gols registados (${totalGoals}) n√£o bate com o placar do seu time (${game.result.score.home})!`); 
                await batch.commit(); 
                await updateDoc(doc(db, "teams", AppState.userData.teamId, "games", game.id), { resultsEntered: true, votingOpen: true });
                UI.render(UI.screenVotacaoCraque, { game }); 
            },
            handleSkipGoals: (game) => { UI.render(UI.screenConfirmAction, { title: 'Pular Artilharia', message: 'Tem certeza que deseja pular o registro de gols e encerrar esta partida?', confirmAction: 'confirm-skip-goals', targetId: game.id }); },
            confirmSkipGoals: async (gameId) => { 
                await updateDoc(doc(db, "teams", AppState.userData.teamId, "games", gameId), { resultsEntered: true, votingOpen: true });
                const game = AppState.games.find(g => g.id === gameId); 
                UI.render(UI.screenVotacaoCraque, { game }); 
            },
            _checkVotingStatus: async (game) => {
                const confirmations = AppState.confirmations[game.id] || [];
                const eligibleVotersCount = confirmations.filter(c => c.status === 'confirmed').length;
                const votesSnapshot = await getDocs(collection(db, `teams/${AppState.userData.teamId}/games/${game.id}/votes`));
                const currentVotesCount = votesSnapshot.size;
                if (currentVotesCount >= eligibleVotersCount) {
                    await updateDoc(doc(db, "teams", AppState.userData.teamId, "games", game.id), { votingOpen: false });
                }
            },
            handleVoteSubmit: async (game, votedPlayerId) => { 
                await setDoc(doc(db, `teams/${AppState.userData.teamId}/games/${game.id}/votes`, AppState.currentUser.uid), { voterId: AppState.currentUser.uid, votedPlayerId }); 
                Game._checkVotingStatus(game);
            },
            handleSkipVote: async (game) => { 
                await setDoc(doc(db, `teams/${AppState.userData.teamId}/games/${game.id}/votes`, AppState.currentUser.uid), { voterId: AppState.currentUser.uid, votedPlayerId: null }); 
                Game._checkVotingStatus(game);
            },
        };

        // =================================================================================
        //  M√ìDULO FINANCEIRO (Financials)
        // =================================================================================
        const Financials = {
            handleSaveFinancials: async (e) => {
                e.preventDefault();
                if (!AppState.team) return;
                const monthlyFee = document.getElementById('monthly-fee').value;
                const pixKey = document.getElementById('pix-key').value;
                const recipientName = document.getElementById('recipient-name').value;
                const bankName = document.getElementById('bank-name').value;
                const financialData = { monthlyFee: parseFloat(monthlyFee) || 0, pixKey: pixKey || '', recipientName: recipientName || '', bankName: bankName || '' };
                try {
                    await updateDoc(doc(db, "teams", AppState.team.id), { financials: financialData });
                    alert('Configura√ß√µes financeiras salvas com sucesso!');
                } catch (error) { console.error("Erro ao salvar configura√ß√µes financeiras:", error); alert("N√£o foi poss√≠vel salvar as configura√ß√µes. Tente novamente."); }
            },

            handleSubmitTransactionId: async (e) => {
                e.preventDefault();
                const transactionId = document.getElementById('transaction-id').value.trim();
                if (!transactionId) {
                    return alert("Por favor, insira o ID da Transa√ß√£o PIX.");
                }
                const btn = e.target.querySelector('button[type="submit"]');
                btn.disabled = true;
                btn.textContent = 'Enviando...';

                const data = {
                    status: 'awaiting_approval',
                    transactionId: transactionId,
                    updatedAt: serverTimestamp()
                };

                const now = new Date();
                const monthId = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                const paymentRef = doc(db, `teams/${AppState.team.id}/payments/${monthId}/players`, AppState.currentUser.uid);
                
                try {
                    await setDoc(paymentRef, data, { merge: true });
                } catch (error) {
                    console.error("Erro ao enviar ID da transa√ß√£o:", error);
                    alert("N√£o foi poss√≠vel enviar a confirma√ß√£o. Tente novamente.");
                    btn.disabled = false;
                    btn.textContent = 'Confirmar Pagamento com ID';
                }
            },
            
            handleManualPaymentToggle: async (playerId, newStatus) => {
                const dataToUpdate = {
                    status: newStatus,
                    updatedAt: serverTimestamp()
                };
                if (newStatus === 'pending') {
                    dataToUpdate.transactionId = deleteField();
                }
                const now = new Date();
                const monthId = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                const paymentRef = doc(db, `teams/${AppState.team.id}/payments/${monthId}/players`, playerId);
                try {
                    await setDoc(paymentRef, dataToUpdate, { merge: true });
                } catch (error) {
                    console.error("Erro ao atualizar pagamento:", error);
                }
            }
        };


        // =================================================================================
        //  M√ìDULO DE UI (TELAS E RENDERIZA√á√ÉO) - ATUALIZADO
        // =================================================================================
        const UI = {
            render: (screen, data = {}) => {
                const mainContainer = document.getElementById('main-container');
                mainContainer.innerHTML = screen(data);
                attachEventListeners();
            },
            
            icons: {
                pencil: `<svg class="edit-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/></svg>`,
                logout: `<svg class="logout-icon" id="logout-btn" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg>`,
                remove: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="remove-player-icon" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg>`,
                info: `<svg class="help-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.064.293.006.399.287.47l.45.082.082-.38-.29-.071c-.293-.07-.352-.176-.288-.469l.738-3.468c.064-.293-.006-.399-.287-.47zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>`
            },
            logoHTML: `<div class="logo-container"><img src="https://i.imgur.com/VQjRRHl.png" alt="Logo Rei da V√°rzea" class="logo-img"></div>`,
            googleButtonHTML: `<div class="login-link" style="margin-bottom: 20px; font-size: 0.9em; color: var(--cor-texto-secundario);">ou</div><button type="button" id="google-signin-btn" class="btn btn-secondary" style="display: flex; align-items: center; justify-content: center; gap: 10px;"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" style="width: 18px; height: 18px;">Continuar com Google</button>`,
            
            screenLogin: () => `<div class="form-container">${UI.logoHTML}<h2>Login</h2><form id="login-form"><div class="input-group"><label for="email">E-mail</label><input type="email" id="email" required></div><div class="input-group"><label for="password">Senha</label><input type="password" id="password" required></div><a href="#" id="forgot-password-btn" style="display: block; text-align: right; font-size: 0.8em; margin-top: -10px; margin-bottom: 20px;">Esqueci minha senha</a><button type="submit" class="btn btn-submit">Entrar</button></form>${UI.googleButtonHTML}<p class="login-link">N√£o tem conta? <a id="show-register-btn" href="#">Cadastre-se</a></p><button type="button" id="install-button" class="btn btn-install" style="display: ${AppState.deferredPrompt ? 'block' : 'none'};">Instalar Aplicativo</button></div>`,
            screenForgotPassword: () => `<div class="form-container">${UI.logoHTML}<h2>Recuperar Senha</h2><p style="text-align:center; color: var(--cor-texto-secundario); margin-bottom: 20px;">Digite seu e-mail para receber o link de recupera√ß√£o.</p><form id="forgot-password-form"><div class="input-group"><label for="email-reset">E-mail</label><input type="email" id="email-reset" required></div><button type="submit" class="btn btn-submit">Enviar</button></form><p class="login-link"><a id="show-login-btn" href="#">Voltar para o Login</a></p></div>`,
            screenCadastro: () => { const posOptions = `<option value="">Selecione...</option><option value="Goleiro">Goleiro</option><option value="Zagueiro">Zagueiro</option><option value="Lateral">Lateral</option><option value="Meio-campista">Meio-campista</option><option value="Atacante">Atacante</option>`; return `<div class="form-container">${UI.logoHTML}<h2>Crie sua Conta</h2><form id="cadastro-form"><div class="input-group"><label for="nome">Seu nome</label><input type="text" id="nome" required></div><div class="input-group"><label for="apelido">Apelido (opcional)</label><input type="text" id="apelido"></div><div class="input-group"><label for="email">Seu e-mail</label><input type="email" id="email" required></div><div class="input-group"><label for="password">Crie uma senha</label><input type="password" id="password" required></div><div class="input-group"><label for="confirm-password">Confirme sua senha</label><input type="password" id="confirm-password" required></div><p class="profile-question" style="font-weight:700;margin:30px 0 15px 0;">Seu perfil?</p><div class="profile-selection"><button type="button" class="btn btn-profile" data-profile="dono">Sou Admin</button><button type="button" class="btn btn-profile" data-profile="jogador">Sou Jogador</button></div><div id="position-field" class="input-group" style="display:none;"><label for="posicao">Sua Posi√ß√£o</label><select id="posicao">${posOptions}</select></div><div class="terms-group"><input type="checkbox" id="terms-agree" required><label for="terms-agree">Eu li e aceito os <a href="#" id="show-terms-btn">Termos de Uso e Pol√≠tica de Privacidade</a></label></div><button type="submit" class="btn btn-submit" style="margin-top: 20px;">CRIAR CONTA</button></form>${UI.googleButtonHTML}<p class="login-link">J√° tem conta? <a id="show-login-btn" href="#">Fa√ßa Login</a></p></div>`;},
            screenChooseProfile: () => { const posOptions = `<option value="">Selecione...</option><option value="Goleiro">Goleiro</option><option value="Zagueiro">Zagueiro</option><option value="Lateral">Lateral</option><option value="Meio-campista">Meio-campista</option><option value="Atacante">Atacante</option>`; return `<div class="form-container">${UI.logoHTML}<h2>Complete seu Cadastro</h2><p style="text-align: center; margin-bottom: 20px;">Bem-vindo(a), ${AppState.currentUser?.displayName || 'jogador(a)'}! Falta s√≥ mais um passo.</p><form id="profile-selection-form"><p class="profile-question" style="font-weight:700;margin:30px 0 15px 0;">Qual seu perfil no time?</p><div class="profile-selection"><button type="button" class="btn btn-profile" data-profile="dono">Sou Admin</button><button type="button" class="btn btn-profile" data-profile="jogador">Sou Jogador</button></div><div id="position-field" class="input-group" style="display:none;"><label for="posicao">Sua Posi√ß√£o</label><select id="posicao">${posOptions}</select></div><button type="submit" class="btn btn-submit">Salvar e Continuar</button></form></div>`; },
            screenDonoCreateTeam: () => `<div class="form-container">${UI.logoHTML}<h2>Crie seu time</h2><form id="dono-form"><div class="input-group"><label for="nome-time">Nome do seu time</label><input type="text" id="nome-time" required></div><button type="submit" class="btn btn-submit">Criar e Avan√ßar</button></form></div>`,
            screenJogadorJoinTeam: () => `<div class="form-container">${UI.logoHTML}<h2>Entre para um Time</h2><form id="jogador-form"><div class="input-group"><label for="codigo-time">C√≥digo de Convite</label><input type="text" id="codigo-time" required></div><button type="submit" class="btn btn-submit">Entrar no Time</button></form></div>`,
            screenAgendarJogo: (data = {}) => {
                const today = new Date().toISOString().split('T')[0];
                const oldGame = data.oldGame || {};
                return `<div class="form-container">${UI.logoHTML.replace('class="logo-img"','class="logo-img" style="max-height: 80px;"')}
                    <h2>Agendar Jogo</h2>
                    <form id="agendar-jogo-form">
                        <div class="input-group">
                            <label>Advers√°rio</label>
                            <input type="text" id="opponent" value="${oldGame.opponent || ''}" required>
                        </div>
                        <div class="input-group">
                            <label>Local</label>
                            <input type="text" id="location" value="${oldGame.location || ''}" required>
                        </div>
                        <div class="input-group">
                            <label>Data</label>
                            <input type="date" id="game-date" min="${today}" required>
                        </div>
                        <div class="input-group">
                            <label>Hora</label>
                            <input type="time" id="game-time" required>
                        </div>
                        <div class="input-group">
                            <label>Dura√ß√£o (minutos)</label>
                            <input type="number" id="game-duration" value="${oldGame.duration || 90}" required>
                        </div>
                        <button type="submit" class="btn btn-submit">Confirmar e Convocar</button>
                    </form>
                </div>`;
            },
            screenDonoDashboard: () => { 
                if (!AppState.team || !AppState.userData) return `<div class="form-container">${UI.logoHTML}<p>Carregando dados do time...</p></div>`; 
                const teamPlayers = AppState.players.filter(p => p.profile === 'jogador'); 
                const upcomingGames = AppState.games.filter(g => !g.resultsEntered).sort((a,b) => new Date(a.dateTime) - new Date(b.dateTime));
                const nextGame = upcomingGames.length > 0 ? upcomingGames[0] : null;
                const hasPendingGame = !!nextGame;
                const agendarBtn = teamPlayers.length >= 2 && !hasPendingGame ? `<button id="agendar-jogo-btn" class="btn btn-submit">+ Agendar Novo Jogo</button>` : `<button class="btn btn-submit" disabled>+ Agendar Novo Jogo</button>`; 
                
                const now = new Date();
                const monthId = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                const monthlyPayments = AppState.payments[monthId] || {};
                const hasPendingPayments = Object.values(monthlyPayments).some(p => p.status === 'awaiting_approval');
                const paymentNotificationDot = hasPendingPayments ? '<span class="notification-dot"></span>' : '';

                const hasPendingPlayers = AppState.players.some(p => p.approved === false);
                const playerNotificationDot = hasPendingPlayers ? '<span class="notification-dot"></span>' : '';

                const financasBtn = AppState.team.subscription?.level === 'varzea' ? `<button id="gestao-financeira-btn" class="btn btn-secondary" style="background-color: var(--cor-azul); color: white; position: relative;">Gest√£o Financeira ${paymentNotificationDot}</button>` : '';
                const devUpgradeBtn = (!AppState.team.subscription || AppState.team.subscription.level === 'free') ? `<button id="dev-upgrade-btn" class="btn" style="background: #444; color: #ccc; font-size: 0.8em; padding: 5px; margin-top: 15px;">DEV: Upgrade para V√°rzea</button>` : '';
                let gameSectionHTML = '<p style="text-align:center; margin-top: 20px;">Nenhuma partida agendada.</p>';
                if (nextGame) {
                    const game = nextGame;
                    const gameStart = new Date(game.dateTime);
                    const gameEnd = new Date(gameStart.getTime() + (game.duration || 90) * 60000);
                    const isGameFinished = new Date() > gameEnd;

                    const registerButtonHTML = `<button class="btn btn-secondary register-results-btn" data-game-id="${game.id}" ${!isGameFinished ? 'disabled' : ''} title="${!isGameFinished ? 'Aguardando o t√©rmino da partida' : 'Registrar resultado do jogo'}">üèÅ Registrar Resultados</button>`;
                    
                    const confirmations = AppState.confirmations[game.id] || [];
                    const confirmed = confirmations.filter(c=>c.status === 'confirmed').map(c=>AppState.players.find(p=>p.id===c.userId)).filter(Boolean);
                    const rejected = confirmations.filter(c=>c.status === 'rejected').map(c=>AppState.players.find(p=>p.id===c.userId)).filter(Boolean);
                    const attendanceHTML = `<div class="attendance-list"><h4>Confirmados (${confirmed.length}):</h4><p>${confirmed.map(p => `${p.name} (${p.position || 'üëë Admin'})`).join(', ') || 'Ningu√©m'}</p></div><div class="attendance-list"><h4>Ausentes (${rejected.length}):</h4><p>${rejected.map(p => `${p.name} (${p.position || 'üëë Admin'})`).join(', ') || 'Ningu√©m'}</p></div>`;
                    const gameActionsHTML = registerButtonHTML + attendanceHTML;
                    gameSectionHTML = `<div class="game-card" data-game-id="${game.id}"><h3>vs ${game.opponent}</h3><p>üóìÔ∏è ${new Date(game.dateTime).toLocaleString('pt-BR')}</p>${gameActionsHTML}</div>`;
                }
                const appUrl = 'https://www.reidavarzea.com.br';
                const mensagemWhatsapp = encodeURIComponent(`E a√≠! Estou te convidando para o meu time no app Rei da V√°rzea.\n\nNosso c√≥digo de acesso √©: *${AppState.team.code}*\n\nBaixe o app e junte-se a n√≥s: ${appUrl}`);
                const whatsappLink = `https://api.whatsapp.com/send?text=${mensagemWhatsapp}`;
                return `<div class="form-container">${UI.dashboardHeader()}${UI.generateDashboardNotifications()}<hr style="border-color:#333;margin:15px 0;">${agendarBtn}${financasBtn}<button id="ver-elenco-btn" class="btn btn-secondary" style="position: relative;">Meu Time ${playerNotificationDot}</button><button id="ver-historico-btn" class="btn btn-secondary">Hist√≥rico de Jogos</button><h2 class="section-title" style="margin-top:20px;">Monte sua equipe!</h2><div class="player-counter">Jogadores no elenco: ${teamPlayers.length}</div><div class="invite-box"><span class="invite-code">${AppState.team.code}</span><a href="${whatsappLink}" target="_blank" class="share-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3s3-1.34 3-3-1.34-3-3-3z"></path></svg><span>Compartilhar</span></a></div><h2 class="section-title" style="margin-top:30px;">Pr√≥ximo Jogo</h2>${gameSectionHTML}${devUpgradeBtn}</div>`;
            },
            screenJogadorDashboard: () => { 
                if (!AppState.team || !AppState.userData) return `<div class="form-container">${UI.logoHTML}<p>Carregando dados do time...</p></div>`; 
                const financasBtn = AppState.team.subscription?.level === 'varzea' ? `<button id="financeiro-jogador-btn" class="btn btn-secondary">Financeiro</button>` : '';
                let gamesHTML = AppState.games.filter(g => !g.resultsEntered).sort((a,b) => new Date(a.dateTime) - new Date(b.dateTime)).map(game => { const confirmations = AppState.confirmations[game.id] || []; const myC = confirmations.find(c => c.userId === AppState.currentUser.uid); let cardClass = '', confirmBtnClass = '', rejectBtnClass = ''; if (myC) { cardClass = myC.status === 'confirmed' ? 'confirmed' : 'rejected'; rejectBtnClass = myC.status === 'confirmed' ? 'dimmed' : ''; confirmBtnClass = myC.status === 'rejected' ? 'dimmed' : ''; } return `<div class="game-card ${cardClass}" data-game-id="${game.id}"><h3>vs ${game.opponent}</h3><p>üìç ${game.location}</p><p>üóìÔ∏è ${new Date(game.dateTime).toLocaleString('pt-BR')}</p><div class="confirmation-buttons" data-game-id="${game.id}"><button class="btn btn-confirm ${confirmBtnClass}">‚úÖ VOU</button><button class="btn btn-reject ${rejectBtnClass}">‚ùå T√î FORA</button></div></div>`; }).join(''); 
                let votePopupHTML = ''; 
                const pendingVoteGame = AppState.games.find(g => { const confirmations = AppState.confirmations[g.id] || []; const votes = AppState.votes[g.id] || []; const myConfirmation = confirmations.find(c => c.userId === AppState.currentUser.uid); const myVote = votes.find(v => v.voterId === AppState.currentUser.uid); return g.votingOpen && myConfirmation?.status === 'confirmed' && !myVote; }); 
                if (pendingVoteGame) { votePopupHTML = `<div class="popup-overlay"><div class="vote-card"><h4>Vota√ß√£o aberta!</h4><p>A vota√ß√£o para o Craque do Time do jogo contra <strong>${pendingVoteGame.opponent}</strong> est√° aberta!</p><button id="go-to-vote-btn" class="btn btn-submit" data-game-id="${pendingVoteGame.id}" style="margin-top: 20px;">Votar Agora!</button></div></div>`; } 
                return `${votePopupHTML}<div class="form-container">${UI.dashboardHeader()}${UI.generateDashboardNotifications()}<hr style="border-color: #333; margin: 20px 0;">${financasBtn}<button id="ver-elenco-btn" class="btn btn-secondary">Meu Time</button><button id="ver-historico-btn" class="btn btn-secondary">Hist√≥rico de Jogos</button><h2 class="section-title" style="margin-top:20px;">Pr√≥ximos Jogos</h2>${gamesHTML || '<p>Nenhum jogo agendado.</p>'}</div>`;
            },
            screenElenco: () => { 
                let membersHTML = AppState.players.map(member => {
                    const isApproved = member.approved !== false; // Trata usu√°rios antigos (sem o campo) como aprovados
                    let actionHTML = '';

                    if (AppState.userData.profile === 'dono' && member.id !== AppState.currentUser.uid) {
                        if (isApproved) {
                            actionHTML = `<a href="#" class="remove-player-link" data-player-id="${member.id}" data-player-name="${member.name}">${UI.icons.remove}</a>`;
                        } else {
                            actionHTML = `<button class="btn btn-confirm approve-player-btn" data-player-id="${member.id}" style="font-size: 0.8em; padding: 6px 10px;">Aprovar</button>`;
                        }
                    }
                    
                    return `<li class="player-list-item ${!isApproved ? 'awaiting-approval' : ''}">
                        <div class="player-info">
                            <span>${member.name}</span>
                            <span class="position">${!isApproved ? 'Aprova√ß√£o Pendente' : (member.position || 'üëë Admin')}</span>
                        </div>
                        ${actionHTML}
                    </li>`;
                }).join(''); 
                return `<div class="form-container">${UI.logoHTML.replace('class="logo-img"','class="logo-img" style="max-height: 80px;"')}<h2>Elenco: ${AppState.team.name}</h2><ul class="player-list">${membersHTML}</ul><button id="voltar-dashboard-btn" class="btn btn-secondary">Voltar</button></div>`;
            },
            screenEditTeam: () => `<div class="modal-overlay"><div class="edit-modal-card"><h2>Editar Time</h2><form id="edit-team-form"><div class="input-group"><label for="edit-team-name">Nome do Time</label><input type="text" id="edit-team-name" value="${AppState.team.name || ''}" required></div><div class="input-group"><label for="edit-team-logo">URL do Logo <span id="logo-help-btn" title="Como obter o URL de uma imagem?">${UI.icons.info}</span></label><input type="url" id="edit-team-logo" placeholder="Cole o link da imagem aqui" value="${AppState.team.logoUrl || ''}"></div><button type="submit" class="btn btn-submit">Salvar Altera√ß√µes</button></form><button id="close-modal-btn" class="btn-skip-vote">Cancelar</button></div></div>`,
            screenEditUser: () => `<div class="modal-overlay"><div class="edit-modal-card"><h2>Editar Perfil</h2><form id="edit-user-form"><div class="input-group"><label for="edit-nome">Seu nome</label><input type="text" id="edit-nome" value="${AppState.userData.name || ''}" required></div><div class="input-group"><label for="edit-apelido">Apelido</label><input type="text" id="edit-apelido" value="${AppState.userData.nickname || ''}"></div><button type="submit" class="btn btn-submit">Salvar Altera√ß√µes</button></form><button id="leave-team-btn" class="btn btn-danger" style="width:100%; margin-top: 15px;">Sair do Time</button><button id="close-modal-btn" class="btn-skip-vote">Cancelar</button></div></div>`,
            screenConfirmAction: ({ title, message, confirmAction, targetId }) => `<div class="modal-overlay"><div class="confirm-modal-card"><h2>${title}</h2><p style="margin: 20px 0; text-align: center;">${message}</p><div style="display: flex; gap: 10px;"><button id="cancel-action-btn" class="btn btn-secondary" style="flex-grow: 1;">Cancelar</button><button id="confirm-action-btn" class="btn btn-danger" style="flex-grow: 1;" data-action="${confirmAction}" data-target-id="${targetId || ''}">Sim, tenho certeza</button></div></div></div>`,
            screenLogoHelp: () => `<div class="modal-overlay" id="logo-help-modal"><div class="help-modal-card"><h2>Como obter o link de um logo?</h2><ul style="text-align: left; margin: 20px 0;"><li>1. Encontre a imagem que deseja usar na internet (Google Imagens, etc.).</li><li>2. No computador, clique com o bot√£o direito do mouse sobre a imagem.</li><li>3. No menu que aparecer, selecione a op√ß√£o <strong>"Copiar endere√ßo da imagem"</strong>.</li><li>4. Volte para o app e cole o link no campo "URL do Logo".</li></ul><button id="close-help-modal-btn" class="btn btn-submit">Entendi!</button></div></div>`,
            screenVotacaoCraque: ({ game }) => { const confirmations = AppState.confirmations[game.id] || []; const confirmedPlayers = confirmations.filter(c => c.status === 'confirmed').map(c => AppState.players.find(p => p.id === c.userId)).filter(Boolean); let playersHTML = confirmedPlayers.filter(p => p.id !== AppState.currentUser.uid).map(p => `<li><button type="button" class="btn btn-profile player-vote-btn" data-player-id="${p.id}">${p.name}</button></li>`).join(''); return `<div class="modal-overlay"><div class="vote-card"><h4>Vota√ß√£o Aberta!</h4><h5>vs ${game.opponent}</h5><hr style="border-color:#333; margin: 15px 0;"><p>Escolha o <strong>Craque do Time</strong>:</p><ul class="player-vote-list">${playersHTML}</ul><button id="confirm-vote-btn" class="btn btn-submit" data-game-id="${game.id}" disabled>Confirmar Voto</button><button id="skip-vote-btn" class="btn-skip-vote" data-game-id="${game.id}">Pular Vota√ß√£o</button></div></div>`; },
            screenRegisterResult: ({ game }) => `<div class="form-container">${UI.logoHTML.replace('class="logo-img"','class="logo-img" style="max-height: 80px;"')}<h2>Resultado Final</h2><h5>vs ${game.opponent}</h5><hr style="border-color:#333; margin: 15px 0;"><form id="result-form" data-game-id="${game.id}"><div class="winner-selection"><h3 class="section-title">Quem venceu?</h3><div class="input-group"><label><input type="radio" name="winner" value="home" required> Nosso time</label></div><div class="input-group"><label><input type="radio" name="winner" value="away"> O Advers√°rio</label></div><div class="input-group"><label><input type="radio" name="winner" value="draw"> Empate</label></div></div><h3 class="section-title">Placar (Opcional)</h3><div class="score-input-container"><span>Nosso Time</span><input type="number" id="score-home" min="0" value="0"><span>X</span><input type="number" id="score-away" min="0" value="0"><span>Advers√°rio</span></div><button type="submit" class="btn btn-submit">Salvar e ir para Artilharia</button></form></div>`,
            screenRegistrarGols: ({ game }) => { const confirmations = AppState.confirmations[game.id] || []; const confirmedPlayers = confirmations.filter(c => c.status === 'confirmed').map(c => AppState.players.find(p => p.id === c.userId)).filter(Boolean); let playersHTML = confirmedPlayers.map(p => `<div class="goal-registration-item"><label for="player-${p.id}">${p.name} (${p.position || 'üëë Admin'})</label><input type="number" class="goal-input" data-player-id="${p.id}" min="0" value="0"></div>`).join(''); return `<div class="form-container">${UI.logoHTML.replace('class="logo-img"','class="logo-img" style="max-height: 80px;"')}<h2>Artilharia da Partida</h2><h5>vs ${game.opponent}</h5><hr style="border-color:#333; margin: 15px 0;"><form id="goal-form" data-game-id="${game.id}">${playersHTML}<button type="submit" class="btn btn-submit" style="margin-top:20px;">Salvar Artilharia</button></form><button id="skip-goals-btn" class="btn-skip-vote" data-game-id="${game.id}">Pular e Encerrar</button></div>`;},
            screenHistorico: () => {
                let gamesHTML = AppState.games
                    .sort((a,b) => new Date(b.dateTime) - new Date(a.dateTime))
                    .filter(g => g.resultsEntered)
                    .map(game => {
                        const { result } = game;
                        const confirmations = AppState.confirmations[game.id] || [];
                        const votes = AppState.votes[game.id] || [];
                        const goals = AppState.goals[game.id] || [];
                        const scoreText = (result.score.home !== undefined && result.score.away !== undefined) ? `(${result.score.home}x${result.score.away})` : '';
                        const winnerText = result.winner === 'draw' ? 'Empate' : `${result.winner === 'home' ? AppState.team.name : game.opponent} venceu`;
                        const eligibleVotersCount = confirmations.filter(c => c.status === 'confirmed').length;
                        let craquesText = 'Vota√ß√£o em andamento...';
                        if (votes.length >= eligibleVotersCount && eligibleVotersCount > 0) {
                            const voteCounts = votes.filter(v => v.votedPlayerId).reduce((acc, vote) => { acc[vote.votedPlayerId] = (acc[vote.votedPlayerId] || 0) + 1; return acc; }, {});
                            const maxVotes = Math.max(0, ...Object.values(voteCounts));
                            const craques = maxVotes > 0 ? Object.keys(voteCounts).filter(id => voteCounts[id] === maxVotes).map(id => AppState.players.find(p=>p.id==id)?.name) : [];
                            craquesText = craques.length > 0 ? craques.join(', ') : 'N/A';
                        }
                        const artilheiros = goals.map(g => { const player = AppState.players.find(u => u.id === g.playerId); return `${player?.name || '...'} (${g.quantity} gols)`; });
                        
                        const reagendarBtn = AppState.userData.profile === 'dono'
                            ? `<button class="btn btn-secondary reagendar-btn" data-game-json='${JSON.stringify(game)}' style="margin-top: 15px;">Agendar Novamente</button>`
                            : '';

                        return `<div class="game-card">
                            <h3>vs ${game.opponent}</h3>
                            <p>üóìÔ∏è ${new Date(game.dateTime).toLocaleString('pt-BR')}</p>
                            <div class="attendance-list">
                                <p><strong>Resultado: ${winnerText} ${scoreText}</strong></p>
                                <p><strong>üèÜ Craque(s):</strong> ${craquesText}</p>
                                <p><strong>‚öΩ Artilharia:</strong> ${artilheiros.join(', ') || 'Sem gols'}</p>
                            </div>
                            ${reagendarBtn}
                        </div>`;
                    }).join('');
                return `<div class="form-container">${UI.logoHTML.replace('class="logo-img"','class="logo-img" style="max-height: 80px;"')}<h2>Hist√≥rico de Jogos</h2>${gamesHTML || '<p>Nenhum jogo no hist√≥rico.</p>'}<button id="voltar-dashboard-btn" class="btn btn-secondary">Voltar</button></div>`;
            },
            screenFinanceiroDono: () => {
                const financials = AppState.team.financials || {};
                const players = AppState.players.filter(p => p.profile === 'jogador');
                const now = new Date();
                const monthId = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                
                let playersHTML = players.map(player => {
                    const payment = AppState.payments[monthId]?.[player.id];
                    const status = payment?.status || 'pending';
                    const isAwaiting = status === 'awaiting_approval';
                    const isPaid = status === 'paid';

                    const playerInfoHTML = `
                        <div class="player-info">
                            <span>${player.name}</span>
                            ${isAwaiting
                                ? `<div class="awaiting-approval-details">ID: <strong>${payment.transactionId || 'N√£o informado'}</strong></div>`
                                : `<span class="position">${player.position || 'Jogador'}</span>`
                            }
                        </div>`;

                    const actionHTML = `
                        <label class="toggle-switch">
                            <input type="checkbox" class="payment-toggle" data-player-id="${player.id}" ${isPaid ? 'checked' : ''}>
                            <span class="slider"></span>
                        </label>`;

                    return `<li class="player-list-item ${isAwaiting ? 'awaiting-approval' : ''}">
                        ${playerInfoHTML}
                        ${actionHTML}
                    </li>`;
                }).join('');

                return `<div class="form-container">
                    ${UI.logoHTML.replace('class="logo-img"','class="logo-img" style="max-height: 80px;"')}
                    <h2>Gest√£o Financeira</h2>
                    <form id="financeiro-form">
                        <h3 class="section-title" style="font-weight: 700; color: var(--cor-amarelo);">Configura√ß√µes</h3>
                        <div class="input-group"><label for="monthly-fee">Valor da Mensalidade (R$)</label><input type="number" id="monthly-fee" placeholder="Ex: 30.00" step="0.01" value="${financials.monthlyFee || ''}"></div>
                        <div class="input-group"><label for="pix-key">Sua Chave PIX</label><input type="text" id="pix-key" placeholder="Telefone, e-mail, CPF/CNPJ ou aleat√≥ria" value="${financials.pixKey || ''}"></div>
                        <div class="input-group"><label for="recipient-name">Nome do Recebedor</label><input type="text" id="recipient-name" placeholder="Seu nome completo" value="${financials.recipientName || ''}"></div>
                        <div class="input-group"><label for="bank-name">Banco</label><input type="text" id="bank-name" placeholder="Ex: Nubank, Ita√∫, etc." value="${financials.bankName || ''}"></div>
                        <button type="submit" class="btn btn-submit">Salvar Configura√ß√µes</button>
                    </form>
                    <hr style="border-color:#333;margin:30px 0;">
                    <h3 class="section-title" style="font-weight: 700; color: var(--cor-amarelo);">Controle de Pagamentos - ${now.toLocaleString('pt-BR', { month: 'long', year: 'numeric' })}</h3>
                    <ul class="player-list">${playersHTML || '<p>Nenhum jogador no elenco.</p>'}</ul>
                    <button id="voltar-dashboard-btn" class="btn btn-secondary">Voltar</button>
                </div>`;
            },
            screenFinanceiroJogador: () => {
                const financials = AppState.team.financials || {};
                const now = new Date();
                const monthId = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                const myPayment = AppState.payments[monthId]?.[AppState.currentUser.uid];
                const status = myPayment?.status || 'pending';
                
                let statusText = 'Pendente';
                let statusClass = 'status-pending';
                let actionAreaHTML = '';

                if (status === 'paid') {
                    statusText = 'Pago';
                    statusClass = 'status-paid';
                } else if (status === 'awaiting_approval') {
                    statusText = 'Aguardando Aprova√ß√£o';
                    statusClass = 'status-awaiting';
                }

                if (status === 'pending') {
                    actionAreaHTML = `
                        <form id="payment-id-form">
                            <div class="input-group">
                                <label for="transaction-id">
                                    ID da Transa√ß√£o PIX 
                                    <span id="show-id-help-btn" title="Onde encontro isso?">${UI.icons.info}</span>
                                </label>
                                <input type="text" id="transaction-id" required>
                            </div>
                            <button type="submit" class="btn btn-submit">Confirmar Pagamento com ID</button>
                        </form>
                    `;
                }

                return `<div class="form-container" id="financeiro-jogador-view">
                    ${UI.logoHTML.replace('class="logo-img"','class="logo-img" style="max-height: 80px;"')}
                    <h2>Pagamento da Mensalidade</h2>
                    <div class="payment-status-box ${statusClass}">Status: ${statusText}</div>
                    <div class="payment-details-box">
                        <p><strong>Valor:</strong> R$ ${financials.monthlyFee || 'N√£o definido'}</p>
                        <p><strong>Chave PIX:</strong> ${financials.pixKey || 'N√£o definida'}</p>
                        <p><strong>Nome:</strong> ${financials.recipientName || 'N√£o definido'}</p>
                        <p><strong>Banco:</strong> ${financials.bankName || 'N√£o definido'}</p>
                    </div>
                    ${actionAreaHTML}
                    <div class="alternative-payment-info">
                        <hr style="border-color:#333;margin:20px 0;">
                        <p>A fun√ß√£o para anexar o comprovante estar√° dispon√≠vel em breve!</p>
                        <p>Por enquanto, se preferir, envie via <strong>WhatsApp</strong> para o admin.</p>
                    </div>
                    <button class="btn btn-secondary" disabled style="width:100%; margin-top: 20px; cursor: not-allowed;">Anexar Comprovante</button>
                    <button id="voltar-dashboard-btn" class="btn btn-secondary">Voltar</button>
                </div>`;
            },
            screenIdHelp: () => `<div class="modal-overlay"><div class="help-modal-card"><h2>Onde encontrar o ID da Transa√ß√£o?</h2><p style="text-align: left; margin: 20px 0;">Ap√≥s fazer um PIX, o aplicativo do seu banco mostra um comprovante. Nele, procure por um c√≥digo chamado "ID da Transa√ß√£o", "ID da Opera√ß√£o" ou "C√≥digo de Autentica√ß√£o".</p><p style="text-align: left; margin-bottom: 20px;">√â um c√≥digo longo de letras e n√∫meros. Copie e cole esse c√≥digo aqui para confirmar seu pagamento.</p><button id="close-modal-btn" class="btn btn-submit">Entendi!</button></div></div>`,
            screenTerms: () => `<div class="form-container">${UI.logoHTML.replace('class="logo-img"','class="logo-img" style="max-height: 80px;"')}<h2>Termos de Uso</h2><p style="font-size: 0.8em; text-align: left; max-height: 400px; overflow-y: auto;">Lorem ipsum dolor sit amet, consectetur adipiscing elit... [Texto completo dos termos e pol√≠tica de privacidade aqui]</p><button id="voltar-cadastro-btn" class="btn btn-secondary">Voltar</button></div>`,
            
            dashboardHeader: () => {
                if (!AppState.team || !AppState.userData) return '';
                const teamLogoPlaceholder = AppState.team.logoUrl ? `<img src="${AppState.team.logoUrl}" class="team-logo" onerror="this.parentElement.innerHTML = '${AppState.team.name.charAt(0).toUpperCase()}';">` : `<div class="team-logo">${AppState.team.name.charAt(0).toUpperCase()}</div>`;
                const teamEditIcon = AppState.userData.profile === 'dono' ? `<a href="#" id="edit-team-btn" title="Editar dados do time">${UI.icons.pencil}</a>` : '';
                const userName = AppState.userData.name ? AppState.userData.name.split(' ')[0] : 'Rei da V√°rzea';
                return `${UI.icons.logout}<div class="dashboard-header">${teamLogoPlaceholder}<div class="team-info"><div class="team-name-container"><h3 class="team-name">${AppState.team.name}</h3>${teamEditIcon}</div><div class="welcome-message"><span>Seja bem-vindo, ${userName}</span><a href="#" id="edit-user-btn" title="Editar meu perfil">${UI.icons.pencil}</a></div></div></div>`;
            },
            generateDashboardNotifications: () => {
                let notificationsHTML = '';
                let seenNotifications = [];
                try {
                    seenNotifications = JSON.parse(localStorage.getItem('seenGameNotifications')) || [];
                } catch (e) {
                    console.error("Could not parse seenGameNotifications from localStorage", e);
                    seenNotifications = []; 
                }

                const finishedGames = AppState.games.filter(g => g.resultsEntered);
                if (finishedGames.length === 0) return '';
                
                const sortedGames = finishedGames.sort((a,b) => new Date(b.dateTime) - new Date(a.dateTime));
                const latestGame = sortedGames[0];

                const game = latestGame;
                const votes = AppState.votes[game.id] || [];
                const goals = AppState.goals[game.id] || [];
                const confirmations = AppState.confirmations[game.id] || [];
                const eligibleVotersCount = confirmations.filter(c => c.status === 'confirmed').length;

                const mvpNotificationId = `${game.id}-mvp`;
                if (eligibleVotersCount > 0 && votes.length >= eligibleVotersCount && !seenNotifications.includes(mvpNotificationId)) {
                    const voteCounts = votes.filter(v => v.votedPlayerId).reduce((acc, vote) => { 
                        acc[vote.votedPlayerId] = (acc[vote.votedPlayerId] || 0) + 1; 
                        return acc; 
                    }, {});
                    
                    if (Object.keys(voteCounts).length > 0) {
                        const maxVotes = Math.max(...Object.values(voteCounts));
                        if (maxVotes > 0) {
                            const mvps = Object.keys(voteCounts).filter(id => voteCounts[id] === maxVotes);
                            if (mvps.includes(AppState.currentUser.uid)) {
                                notificationsHTML += `<div class="dashboard-notification mvp" data-notification-id="${mvpNotificationId}"><button class="notification-close-btn" title="Dispensar">&times;</button><p>üèÜ Parab√©ns! Voc√™ foi eleito o <strong>Craque da Partida</strong> contra ${game.opponent}!</p></div>`;
                            }
                        }
                    }
                }

                const goalsNotificationId = `${game.id}-goals`;
                if (!seenNotifications.includes(goalsNotificationId)) {
                    const myGoals = goals.find(g => g.playerId === AppState.currentUser.uid);
                    if (myGoals && myGoals.quantity > 0) {
                        notificationsHTML += `<div class="dashboard-notification" data-notification-id="${goalsNotificationId}"><button class="notification-close-btn" title="Dispensar">&times;</button><p>‚öΩ Voc√™ marcou <strong>${myGoals.quantity} gol(s)</strong> na partida contra ${game.opponent}!</p></div>`;
                    }
                }

                return notificationsHTML ? `<div class="dashboard-notification-area">${notificationsHTML}</div>` : '';
            },
        };

        // =================================================================================
        //  FUN√á√ÉO PRINCIPAL DE INICIALIZA√á√ÉO
        // =================================================================================
        function init() {
            onAuthStateChanged(auth, user => {
                if (typeof AppState.unsubscribe === 'function') AppState.unsubscribe();
                if (user) {
                    AppState.currentUser = user;
                    listenToUserData(user.uid);
                } else {
                    Object.assign(AppState, { currentUser: null, userData: null, team: null, players: [], games: [], confirmations: {}, votes: {}, goals: {}, payments: {}, unsubscribe: () => {} });
                    UI.render(UI.screenLogin);
                }
            });
        
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                AppState.deferredPrompt = e;
                if (document.getElementById('login-form') || document.getElementById('cadastro-form')) {
                    if(AppState.currentUser) return;
                    const isLoginScreen = !!document.getElementById('login-form');
                    if(isLoginScreen) UI.render(UI.screenLogin); else UI.render(UI.screenCadastro);
                }
            });

            function listenToUserData(userId) {
                const userDocRef = doc(db, "users", userId);
                AppState.unsubscribe = onSnapshot(userDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        AppState.userData = { id: docSnap.id, ...docSnap.data() };
                        if (!AppState.userData.profile) UI.render(UI.screenChooseProfile); 
                        else if (AppState.userData.teamId) listenToTeamData(AppState.userData.teamId);
                        else {
                            if (AppState.userData.profile === 'dono') UI.render(UI.screenDonoCreateTeam);
                            else UI.render(UI.screenJogadorJoinTeam);
                        }
                    } else { UI.render(UI.screenChooseProfile); }
                });
            }

            function listenToTeamData(teamId) {
                const unsubscribers = [];
                const onError = (error, context) => {
                    console.error(`Firebase permission error in snapshot listener for [${context}]. Check your Firestore security rules.`, error);
                };

                unsubscribers.push(onSnapshot(doc(db, "teams", teamId), (docSnap) => {
                    AppState.team = docSnap.exists() ? { id: docSnap.id, ...docSnap.data() } : null;
                    if (AppState.userData?.profile === 'dono') UI.render(UI.screenDonoDashboard); else UI.render(UI.screenJogadorDashboard);
                }, (e) => onError(e, 'Team Document')));

                unsubscribers.push(onSnapshot(query(collection(db, "users"), where("teamId", "==", teamId)), (snapshot) => {
                    AppState.players = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    if (AppState.userData?.profile === 'dono') UI.render(UI.screenDonoDashboard); else UI.render(UI.screenJogadorDashboard);
                }, (e) => onError(e, 'Players Collection')));

                const gamesCollectionRef = collection(db, "teams", teamId, "games");
                unsubscribers.push(onSnapshot(query(gamesCollectionRef), (snapshot) => {
                    AppState.games = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    AppState.games.forEach(game => listenToGameSubcollections(teamId, game.id));
                    if (AppState.userData?.profile === 'dono') UI.render(UI.screenDonoDashboard); else UI.render(UI.screenJogadorDashboard);
                }, (e) => onError(e, 'Games Collection')));

                const now = new Date();
                const monthId = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                const paymentsCollectionRef = collection(db, `teams/${teamId}/payments/${monthId}/players`);

                if (AppState.userData.profile === 'dono') {
                    unsubscribers.push(onSnapshot(paymentsCollectionRef, (snapshot) => {
                        AppState.payments[monthId] = {};
                        snapshot.docs.forEach(doc => {
                            AppState.payments[monthId][doc.id] = doc.data();
                        });
                        if (document.getElementById('financeiro-form')) UI.render(UI.screenFinanceiroDono);
                        else if (document.querySelector('.dashboard-header')) UI.render(UI.screenDonoDashboard);
                    }, (e) => onError(e, 'Payments Collection (Admin)')));
                } else if (AppState.userData.profile === 'jogador') {
                    const playerPaymentDocRef = doc(paymentsCollectionRef, AppState.currentUser.uid);
                    unsubscribers.push(onSnapshot(playerPaymentDocRef, (docSnap) => {
                        AppState.payments[monthId] = AppState.payments[monthId] || {};
                        if (docSnap.exists()) {
                            AppState.payments[monthId][docSnap.id] = docSnap.data();
                        } else {
                            delete AppState.payments[monthId][AppState.currentUser.uid];
                        }
                        if (document.getElementById('financeiro-jogador-view')) UI.render(UI.screenFinanceiroJogador);
                        else if (document.querySelector('.dashboard-header')) UI.render(UI.screenJogadorDashboard);
                    }, (e) => onError(e, 'Payment Document (Player)')));
                }

                AppState.unsubscribe = () => unsubscribers.forEach(unsub => unsub());
            }

            function listenToGameSubcollections(teamId, gameId) {
                const gamePath = `teams/${teamId}/games/${gameId}`;
                onSnapshot(collection(db, `${gamePath}/confirmations`), snap => { AppState.confirmations[gameId] = snap.docs.map(d => ({ id: d.id, ...d.data() })); if (AppState.userData?.profile === 'dono') UI.render(UI.screenDonoDashboard); else UI.render(UI.screenJogadorDashboard); });
                onSnapshot(collection(db, `${gamePath}/votes`), snap => { AppState.votes[gameId] = snap.docs.map(d => ({ id: d.id, ...d.data() })); if (AppState.userData?.profile === 'dono') UI.render(UI.screenDonoDashboard); else UI.render(UI.screenJogadorDashboard); });
                onSnapshot(collection(db, `${gamePath}/goals`), snap => { AppState.goals[gameId] = snap.docs.map(d => ({ id: d.id, ...d.data() })); if (AppState.userData?.profile === 'dono') UI.render(UI.screenDonoDashboard); else UI.render(UI.screenJogadorDashboard); });
            }
        }
        
        // =================================================================================
        //  FUN√á√ÉO PARA ANEXAR EVENT LISTENERS
        // =================================================================================
        function attachEventListeners() {
            // Navega√ß√£o e Autentica√ß√£o
            document.getElementById('show-register-btn')?.addEventListener('click', () => UI.render(UI.screenCadastro));
            document.getElementById('show-login-btn')?.addEventListener('click', () => UI.render(UI.screenLogin));
            document.getElementById('login-form')?.addEventListener('submit', Auth.handleLogin);
            document.getElementById('forgot-password-btn')?.addEventListener('click', () => UI.render(UI.screenForgotPassword));
            document.getElementById('forgot-password-form')?.addEventListener('submit', Auth.handleForgotPassword);
            document.getElementById('google-signin-btn')?.addEventListener('click', Auth.handleGoogleSignIn);
            document.getElementById('logout-btn')?.addEventListener('click', Auth.handleLogout);
            document.getElementById('cadastro-form')?.addEventListener('submit', Auth.handleCadastroSubmit);
            document.getElementById('show-terms-btn')?.addEventListener('click', (e) => { e.preventDefault(); UI.render(UI.screenTerms); });
            document.getElementById('voltar-cadastro-btn')?.addEventListener('click', () => UI.render(UI.screenCadastro));

            // Modais e Edi√ß√£o
            document.getElementById('edit-team-btn')?.addEventListener('click', (e) => { e.preventDefault(); UI.render(UI.screenEditTeam); });
            document.getElementById('edit-user-btn')?.addEventListener('click', (e) => { e.preventDefault(); UI.render(UI.screenEditUser); });
            document.getElementById('close-modal-btn')?.addEventListener('click', () => { if (AppState.userData.profile === 'dono') UI.render(UI.screenDonoDashboard); else UI.render(UI.screenJogadorDashboard); });
            document.getElementById('logo-help-btn')?.addEventListener('click', () => { const helpModal = document.createElement('div'); helpModal.innerHTML = UI.screenLogoHelp(); document.body.appendChild(helpModal); document.getElementById('close-help-modal-btn').addEventListener('click', () => { document.getElementById('logo-help-modal').parentElement.remove(); }); });
            document.getElementById('edit-user-form')?.addEventListener('submit', Auth.handleUpdateUser);
            document.getElementById('edit-team-form')?.addEventListener('submit', Team.handleUpdateTeam);
            
            // A√ß√µes de Confirma√ß√£o
            document.getElementById('leave-team-btn')?.addEventListener('click', Team.handleLeaveTeam);
            document.querySelectorAll('.remove-player-link').forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); Team.handleRemovePlayer(e.currentTarget.dataset.playerId, e.currentTarget.dataset.playerName); }); });
            document.getElementById('cancel-action-btn')?.addEventListener('click', () => { if (AppState.userData.profile === 'dono') UI.render(UI.screenDonoDashboard); else UI.render(UI.screenJogadorDashboard); });
            const confirmBtn = document.getElementById('confirm-action-btn');
            if (confirmBtn) {
                confirmBtn.addEventListener('click', () => {
                    const action = confirmBtn.dataset.action;
                    const targetId = confirmBtn.dataset.targetId;
                    if (action === 'confirm-leave-team') Team.confirmLeaveTeam();
                    else if (action === 'confirm-remove-player') Team.confirmRemovePlayer(targetId);
                    else if (action === 'confirm-skip-goals') Game.confirmSkipGoals(targetId);
                });
            }

            // Fluxo de Cadastro e Cria√ß√£o de Time
            const profileSelectionForm = document.getElementById('profile-selection-form');
            if(profileSelectionForm) {
                const b = profileSelectionForm.querySelectorAll('.btn-profile'); const p = document.getElementById('position-field'); const s = p.querySelector('select');
                b.forEach(B => { B.addEventListener('click', function() { b.forEach(n => n.classList.remove('selected')); this.classList.add('selected'); AppState.selectedProfile = this.dataset.profile; if(AppState.selectedProfile === 'jogador'){ p.style.display = 'block'; s.required = true; } else { p.style.display = 'none'; s.required = false; }}); });
                profileSelectionForm.addEventListener('submit', Auth.handleProfileSelection);
            }
            const cadastroForm = document.getElementById('cadastro-form'); if (cadastroForm) { const b = cadastroForm.querySelectorAll('.btn-profile'); const p = document.getElementById('position-field'); const s = p.querySelector('select'); b.forEach(B => { B.addEventListener('click', function() { b.forEach(n => n.classList.remove('selected')); this.classList.add('selected'); AppState.selectedProfile = this.dataset.profile; if(AppState.selectedProfile === 'jogador'){ p.style.display = 'block'; s.required = true; } else { p.style.display = 'none'; s.required = false; } }); }); }
            document.getElementById('dono-form')?.addEventListener('submit', Team.handleDonoSubmit);
            document.getElementById('jogador-form')?.addEventListener('submit', Team.handleJogadorSubmit);
            document.querySelectorAll('.approve-player-btn').forEach(button => {
                button.addEventListener('click', function() {
                    Team.handleApprovePlayer(this.dataset.playerId);
                });
            });
            
            // Fluxo de Jogos
            document.getElementById('agendar-jogo-btn')?.addEventListener('click', () => UI.render(UI.screenAgendarJogo));
            document.getElementById('agendar-jogo-form')?.addEventListener('submit', Game.handleAgendarJogo);
            document.querySelectorAll('.confirmation-buttons').forEach(div => { const gameId = div.dataset.gameId; if (!gameId) return; div.querySelector('.btn-confirm')?.addEventListener('click', () => Game.handleConfirmation(gameId, 'confirmed')); div.querySelector('.btn-reject')?.addEventListener('click', () => Game.handleConfirmation(gameId, 'rejected')); });
            document.querySelectorAll('.register-results-btn').forEach(b => b.addEventListener('click', function() { Game.handleRegisterResults(this.dataset.gameId); }));
            const resultForm = document.getElementById('result-form'); if(resultForm) { resultForm.addEventListener('submit', (e) => Game.handleGameResultSubmit(e, AppState.games.find(g=>g.id === resultForm.dataset.gameId)));}
            const goalForm = document.getElementById('goal-form'); if(goalForm) { const game = AppState.games.find(g=>g.id === goalForm.dataset.gameId); goalForm.addEventListener('submit', (e) => Game.handleGoalSubmit(e, game)); document.getElementById('skip-goals-btn').addEventListener('click', () => Game.handleSkipGoals(game)); }
            
            document.querySelectorAll('.reagendar-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const gameData = JSON.parse(this.dataset.gameJson);
                    Game.handleReagendarJogo(gameData);
                });
            });

            // Navega√ß√£o do Dashboard
            document.getElementById('ver-elenco-btn')?.addEventListener('click', () => UI.render(UI.screenElenco));
            document.getElementById('ver-historico-btn')?.addEventListener('click', () => UI.render(UI.screenHistorico));
            document.getElementById('voltar-dashboard-btn')?.addEventListener('click', () => { if (AppState.userData.profile === 'dono') UI.render(UI.screenDonoDashboard); else UI.render(UI.screenJogadorDashboard); });
            document.getElementById('go-to-financials-from-notification')?.addEventListener('click', () => UI.render(UI.screenFinanceiroDono));

            // Gest√£o Financeira
            document.getElementById('gestao-financeira-btn')?.addEventListener('click', () => UI.render(UI.screenFinanceiroDono));
            document.getElementById('financeiro-jogador-btn')?.addEventListener('click', () => UI.render(UI.screenFinanceiroJogador));
            document.getElementById('dev-upgrade-btn')?.addEventListener('click', Team.handleDevUpgrade);
            document.getElementById('financeiro-form')?.addEventListener('submit', Financials.handleSaveFinancials);
            document.getElementById('payment-id-form')?.addEventListener('submit', Financials.handleSubmitTransactionId);
            document.getElementById('show-id-help-btn')?.addEventListener('click', () => {
                const helpModal = document.createElement('div');
                helpModal.innerHTML = UI.screenIdHelp();
                document.body.appendChild(helpModal);
                helpModal.querySelector('#close-modal-btn').addEventListener('click', () => {
                    helpModal.remove();
                });
            });
            document.querySelectorAll('.payment-toggle').forEach(toggle => {
                toggle.addEventListener('change', function(e) {
                    const playerId = this.dataset.playerId;
                    const status = e.currentTarget.checked ? 'paid' : 'pending';
                    Financials.handleManualPaymentToggle(playerId, status);
                });
            });

            // Vota√ß√£o
            const confirmVoteBtn = document.getElementById('confirm-vote-btn'); if(confirmVoteBtn) { let selectedPlayerId = null; document.querySelectorAll('.player-vote-btn').forEach(button => { button.addEventListener('click', function() { document.querySelectorAll('.player-vote-btn').forEach(btn => btn.classList.remove('selected')); this.classList.add('selected'); selectedPlayerId = this.dataset.playerId; confirmVoteBtn.disabled = false; }); }); const game = AppState.games.find(g=>g.id === confirmVoteBtn.dataset.gameId); if(game) { confirmVoteBtn.addEventListener('click', () => Game.handleVoteSubmit(game, selectedPlayerId)); document.getElementById('skip-vote-btn').addEventListener('click', () => Game.handleSkipVote(game)); } }
            document.getElementById('go-to-vote-btn')?.addEventListener('click', function() { const game = AppState.games.find(g => g.id === this.dataset.gameId); if (game) UI.render(UI.screenVotacaoCraque, { game }); });
        
            // Notifica√ß√µes
            document.querySelectorAll('.notification-close-btn').forEach(btn => {
                btn.addEventListener('click', function(e){
                    e.stopPropagation();
                    const notificationDiv = this.closest('.dashboard-notification');
                    const notificationId = notificationDiv.dataset.notificationId;
                    if(notificationId) {
                        try {
                            let seen = JSON.parse(localStorage.getItem('seenGameNotifications')) || [];
                            if(!seen.includes(notificationId)) {
                                seen.push(notificationId);
                                localStorage.setItem('seenGameNotifications', JSON.stringify(seen));
                            }
                        } catch(err) { console.error("Error with localStorage for notifications", err); }
                    }
                    notificationDiv.style.display = 'none';
                });
            });
        }

        // Inicia a aplica√ß√£o
        init();

    </script>

    <!-- Script do Service Worker -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => console.log('Service Worker registrado com sucesso.'))
                    .catch(error => console.log('Falha ao registrar Service Worker:', error));
            });
        }
        
        async function handleInstallClick() {
            if (AppState.deferredPrompt) {
                const installButton = document.getElementById('install-button');
                if(installButton) installButton.style.display = 'none';

                AppState.deferredPrompt.prompt();
                const { outcome } = await AppState.thedPrompt.userChoice;
                console.log(`User response to the install prompt: ${outcome}`);
                AppState.deferredPrompt = null;
            }
        }
    </script>
</body>
</html>


